# 数据库主从一致性

数据冗余一定会有一致的问题。多份冗余的数据不能在同一时间修改，多个数据之间的变更会有时间差，这个时间差就会导致一致性的问题。

数据冗余有三种情况： 主从数据冗余，主主数据冗余，数据与缓存冗余。

### 主从数据冗余

主库与从军有数据同步，上游服务读从库，写主库，主从有延时。当服务发起写请求之后，在数据同步这段时间内，服务再发起读请求，此时，数据还未同步完成，就会读到脏数据。

解决这个问题有3个方案：

1. 忽略不计。主从不一致的时间很短，有的业务允许一定的延时。
2. 强制读主。强制读主，放弃了读写分离，一主多从的分组架构。从库主要是增加读性能，强制读主要增加读性能，必须使用缓存的方式。
3. 选择性读主。上游服务发起请求，写数据到主库。同时，在缓存记录哪个库哪个表哪个主键，并将这个记录的超时时间设置为主从同步的时间。上游服务发起读请求时，先到缓存查看有没这个记录，有记录读主库，没记录读从库。

### 主主数据冗余

主主同时对外提供服务，数据的同步有一个时间差。并发写入会导致同步失败。比如同个主键冲突。

解决问题方案：

1. 数据库层面解决，设置不同的初始值，相同的步长。如两个主库设置双向同步，一个初始值设为1，另一个设为2，步长为2。两个互相同步，最终就会数据一致性。会有数据库运维的复杂。
2. 上层应用程序控制 id 生成。如雪花算法。
3. 升级为单主服务，通过 keepalive + vip 的方式。此时资源利用率只有 50%。

### 数据库与缓存

后继讲解。

